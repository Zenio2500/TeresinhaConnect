<div class="mb-4">
  <h1>Escalas Lit√∫rgicas</h1>
  <p style="color: var(--gray-600);">Gerencie as escalas de leitores para as celebra√ß√µes</p>
</div>

<div style="display: flex; gap: var(--spacing-lg); flex-direction: row-reverse;">
  <!-- Lista lateral de leitores dispon√≠veis -->
  <div class="readers-sidebar" style="width: 250px; flex-shrink: 0;">
    <div class="card" style="position: sticky; top: 20px;">
      <div class="card-header">
        <h3 class="card-title" style="font-size: 1rem;">Leitores Dispon√≠veis</h3>
      </div>
      <div class="card-body" style="padding: var(--spacing-sm);">
        <div id="available-readers" style="max-height: 600px; overflow-y: auto;">
          <% @readers.includes(:user).order('users.name').each do |reader| %>
            <% first_name = reader.user.name.split.first %>
            <div class="reader-item" 
                 draggable="true" 
                 data-reader-id="<%= reader.id %>"
                 data-reader-name="<%= first_name %>"
                 style="padding: var(--spacing-sm); margin-bottom: var(--spacing-xs); background: var(--gray-100); border-radius: 4px; cursor: move; font-size: 0.9rem;">
              üìñ <%= first_name %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela de escalas com drag-and-drop -->
  <div style="flex: 1; min-width: 0;">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Todas as Escalas (<%= @grades.count %>)</h3>
        <div class="btn-group">
          <%= link_to "‚ûï Nova Escala", new_grade_path, class: "btn btn-primary" %>
          <% liturgia_pastoral = Pastoral.find_by("LOWER(name) = ?", "liturgia") %>
          <% if liturgia_pastoral %>
            <%= link_to "Voltar", pastoral_path(liturgia_pastoral), class: "btn btn-secondary" %>
          <% end %>
        </div>
      </div>
      
      <div class="card-body p-0">
        <% if @grades.any? %>
          <div class="table-container">
            <table class="table" id="grades-table">
              <thead>
                <tr>
                  <th style="width: 120px;">Data</th>
                  <th style="width: 140px;">1¬™ Leitura</th>
                  <th style="width: 140px;">Salmo</th>
                  <th style="width: 140px;">2¬™ Leitura</th>
                  <th style="width: 140px;">Preces</th>
                  <th class="text-center" style="width: 280px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <% @grades.order(date: :asc).each do |grade| %>
                  <tr data-grade-id="<%= grade.id %>">
                    <td><strong><%= grade.date.strftime("%d/%m/%Y") %></strong></td>
                    
                    <!-- 1¬™ Leitura -->
                    <td class="drop-zone" data-reader-type="1¬™ Leitura" data-grade-id="<%= grade.id %>">
                      <% first_reading = grade.reader_grades.find_by(reader_type: '1¬™ Leitura') %>
                      <% if first_reading %>
                        <% first_name = first_reading.reader.user.name.split.first %>
                        <div class="assigned-reader" data-reader-grade-id="<%= first_reading.id %>" draggable="true">
                          <%= first_name %>
                          <span class="remove-reader" onclick="removeReader(<%= first_reading.id %>)">√ó</span>
                        </div>
                      <% end %>
                    </td>
                    
                    <!-- Salmo -->
                    <td class="drop-zone" data-reader-type="Salmo" data-grade-id="<%= grade.id %>">
                      <% salmo = grade.reader_grades.find_by(reader_type: 'Salmo') %>
                      <% if salmo %>
                        <% first_name = salmo.reader.user.name.split.first %>
                        <div class="assigned-reader" data-reader-grade-id="<%= salmo.id %>" draggable="true">
                          <%= first_name %>
                          <span class="remove-reader" onclick="removeReader(<%= salmo.id %>)">√ó</span>
                        </div>
                      <% end %>
                    </td>
                    
                    <!-- 2¬™ Leitura -->
                    <td class="drop-zone" data-reader-type="2¬™ Leitura" data-grade-id="<%= grade.id %>">
                      <% second_reading = grade.reader_grades.find_by(reader_type: '2¬™ Leitura') %>
                      <% if second_reading %>
                        <% first_name = second_reading.reader.user.name.split.first %>
                        <div class="assigned-reader" data-reader-grade-id="<%= second_reading.id %>" draggable="true">
                          <%= first_name %>
                          <span class="remove-reader" onclick="removeReader(<%= second_reading.id %>)">√ó</span>
                        </div>
                      <% end %>
                    </td>
                    
                    <!-- Preces -->
                    <td class="drop-zone" data-reader-type="Preces" data-grade-id="<%= grade.id %>">
                      <% preces = grade.reader_grades.find_by(reader_type: 'Preces') %>
                      <% if preces %>
                        <% first_name = preces.reader.user.name.split.first %>
                        <div class="assigned-reader" data-reader-grade-id="<%= preces.id %>" draggable="true">
                          <%= first_name %>
                          <span class="remove-reader" onclick="removeReader(<%= preces.id %>)">√ó</span>
                        </div>
                      <% end %>
                    </td>
                    
                    <td class="text-center">
                      <div style="display: flex; gap: 4px; justify-content: center;">
                        <%= link_to "Ver", grade_path(grade), class: "btn btn-sm btn-secondary" %>
                        <%= link_to "Editar", edit_grade_path(grade), class: "btn btn-sm btn-warning" %>
                        <button type="button" class="btn btn-sm btn-danger" onclick="showDeleteGradeModal<%= grade.id %>()">Excluir</button>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p style="color: var(--gray-600); text-align: center; padding: var(--spacing-xl);">
            Nenhuma escala cadastrada ainda.
          </p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Modais de Confirma√ß√£o de Exclus√£o -->
<% @grades.each do |grade| %>
  <div id="delete-grade-modal-<%= grade.id %>" class="modal-overlay" style="display: none;">
    <div class="confirmation-modal">
      <div class="modal-header">
        <span class="modal-icon danger">üóëÔ∏è</span>
        <h3 class="modal-title">Confirmar Exclus√£o de Escala</h3>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir a escala de <strong><%= grade.date.strftime("%d/%m/%Y") %></strong>?</p>
        <p>Esta a√ß√£o n√£o pode ser desfeita.</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeDeleteGradeModal<%= grade.id %>()">Cancelar</button>
        <%= button_to "Confirmar Exclus√£o", grade_path(grade), 
            method: :delete, 
            class: "btn btn-danger" %>
      </div>
    </div>
  </div>
<% end %>

<script>
  <% @grades.each do |grade| %>
    function showDeleteGradeModal<%= grade.id %>() {
      document.getElementById('delete-grade-modal-<%= grade.id %>').style.display = 'flex';
    }
    
    function closeDeleteGradeModal<%= grade.id %>() {
      document.getElementById('delete-grade-modal-<%= grade.id %>').style.display = 'none';
    }
    
    document.getElementById('delete-grade-modal-<%= grade.id %>').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteGradeModal<%= grade.id %>();
      }
    });
  <% end %>
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
      });
    }
  });
</script>

<!-- Estilos CSS para Drag and Drop -->
<style>
  .drop-zone {
    min-height: 40px;
    padding: var(--spacing-xs);
    border: 2px dashed transparent;
    transition: all 0.2s;
    position: relative;
  }
  
  .drop-zone.drag-over {
    border-color: var(--primary-color);
    background-color: rgba(var(--primary-rgb), 0.1);
  }
  
  .assigned-reader {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: 4px 8px;
    background: var(--primary-color);
    color: white;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: move;
  }
  
  .assigned-reader.dragging {
    opacity: 0.5;
  }
  
  .remove-reader {
    cursor: pointer;
    font-weight: bold;
    padding: 0 4px;
    border-radius: 3px;
    transition: background 0.2s;
  }
  
  .remove-reader:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  .reader-item {
    transition: all 0.2s;
  }
  
  .reader-item:hover {
    background: var(--gray-200) !important;
    transform: translateX(4px);
  }
  
  .reader-item.dragging {
    opacity: 0.5;
  }
</style>

<!-- JavaScript para Drag and Drop -->
<script>
  let draggedElement = null;
  let draggedReaderId = null;
  let draggedReaderName = null;
  let draggedReaderGradeId = null;

  function initializeDragAndDrop() {
    // Configurar drag para leitores dispon√≠veis
    document.querySelectorAll('.reader-item').forEach(item => {
      item.addEventListener('dragstart', function(e) {
        draggedElement = this;
        draggedReaderId = this.dataset.readerId;
        draggedReaderName = this.dataset.readerName;
        draggedReaderGradeId = null;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'copy';
      });
      
      item.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
      });
    });

    // Configurar drag para leitores j√° designados
    document.querySelectorAll('.assigned-reader').forEach(item => {
      item.addEventListener('dragstart', function(e) {
        draggedElement = this;
        draggedReaderId = null;
        draggedReaderName = this.textContent.trim().replace('√ó', '').trim();
        draggedReaderGradeId = this.dataset.readerGradeId;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      
      item.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
      });
    });

    // Configurar drop zones
    document.querySelectorAll('.drop-zone').forEach(zone => {
      zone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
      });
      
      zone.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
      });
      
      zone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const gradeId = this.dataset.gradeId;
        const readerType = this.dataset.readerType;
        
        // Verificar se j√° existe um leitor designado
        if (this.querySelector('.assigned-reader')) {
          alert('J√° existe um leitor designado para este tipo de leitura. Remova-o primeiro.');
          return;
        }
        
        // Se estiver arrastando de um leitor dispon√≠vel
        if (draggedReaderId) {
          addReaderToGrade(gradeId, draggedReaderId, readerType, draggedReaderName, this);
        }
        // Se estiver movendo de outra posi√ß√£o
        else if (draggedReaderGradeId) {
          // Remover da posi√ß√£o anterior e adicionar na nova
          moveReaderToNewPosition(draggedReaderGradeId, gradeId, readerType, draggedReaderName, this);
        }
      });
    });
  }

  function addReaderToGrade(gradeId, readerId, readerType, readerName, dropZone) {
    fetch(`/grades/${gradeId}/add_reader`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        reader_id: readerId,
        reader_type: readerType
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Adicionar o leitor visualmente
        const readerDiv = document.createElement('div');
        readerDiv.className = 'assigned-reader';
        readerDiv.setAttribute('data-reader-grade-id', data.reader_grade.id);
        readerDiv.setAttribute('draggable', 'true');
        readerDiv.innerHTML = `${readerName} <span class="remove-reader" onclick="removeReader(${data.reader_grade.id})">√ó</span>`;
        
        // Configurar drag para o novo elemento
        readerDiv.addEventListener('dragstart', function(e) {
          draggedElement = this;
          draggedReaderId = null;
          draggedReaderName = readerName;
          draggedReaderGradeId = data.reader_grade.id;
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        readerDiv.addEventListener('dragend', function(e) {
          this.classList.remove('dragging');
        });
        
        dropZone.appendChild(readerDiv);
      } else {
        alert('Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao adicionar leitor');
    });
  }

  function moveReaderToNewPosition(readerGradeId, newGradeId, newReaderType, readerName, dropZone) {
    const oldGradeId = draggedElement.closest('tr').dataset.gradeId;
    
    // Primeiro remover da posi√ß√£o antiga
    fetch(`/grades/${oldGradeId}/remove_reader`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        reader_grade_id: readerGradeId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Remover visualmente da posi√ß√£o antiga
        draggedElement.remove();
        
        // Adicionar na nova posi√ß√£o usando o reader_id retornado
        addReaderToGrade(newGradeId, data.reader_id, newReaderType, readerName, dropZone);
      } else {
        alert('Erro ao mover leitor: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao mover leitor');
    });
  }

  function removeReader(readerGradeId) {
    if (!confirm('Deseja remover este leitor da escala?')) {
      return;
    }
    
    const readerElement = document.querySelector(`[data-reader-grade-id="${readerGradeId}"]`);
    const gradeId = readerElement.closest('tr').dataset.gradeId;
    
    fetch(`/grades/${gradeId}/remove_reader`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        reader_grade_id: readerGradeId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        readerElement.remove();
      } else {
        alert('Erro ao remover leitor');
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao remover leitor');
    });
  }

  // Inicializar drag and drop quando a p√°gina carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDragAndDrop);
  } else {
    initializeDragAndDrop();
  }

  // Reinicializar quando Turbo carregar a p√°gina
  document.addEventListener('turbo:load', initializeDragAndDrop);
</script>
